# Домашнее задание к занятию 17 «Инцидент-менеджмент»

## Основная часть

Составьте постмортем на основе реального сбоя системы GitHub в 2018 году.

Информация о сбое: 

* [в виде краткой выжимки на русском языке](https://habr.com/ru/post/427301/);
* [развёрнуто на английском языке](https://github.blog/2018-10-30-oct21-post-incident-analysis/).

---

| Этап                           | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|--------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Краткое описание инцидента** | После непродолжительной потери связи между датацентрами, нарушилась топология кластеров, что привело к нарушению работы сервиса                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Предшествующие события**     | Плановые работы по замене вышедшего из строя оптического оборудования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Причина инцидента**          | После потери связи между датацентрами, протокол Raft запустил процесс определения лидера(им был выбрал кластер US West). После восстановления связи запись данных продолжилась согласно новой топологии. Из-за того, что в Восточном ЦОД оставались не реплицированные данные, перенос роли лидера не мог быть завешён безопастно. Ниже приведён пример<br> **нормального состояния кластеров:**<br> ![norm](https://github.com/Rain-m-a-n/devops-netology/blob/master/%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B%20%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3%D0%B0/Home_Work_(10.6)/pics/normal.jpg)<br> **После сбоя:**<br> ![norm](https://github.com/Rain-m-a-n/devops-netology/blob/master/%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B%20%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3%D0%B0/Home_Work_(10.6)/pics/error.jpg)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Воздействие**                | Этот сбой затронул несколько внутренних систем, в результате чего отображалась устаревшая и непоследовательная информация. В большинстве случаев GitHub не мог обрабатывать webhook события или строить и публиковать GitHub Pages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Обнаружение**                | Внутренние системы мониторинга начали генерировать оповещения, указывающие на многочисленные сбои в системах. Инженеры 1 линии поддержки определили, что топологии многочисленных кластеров баз данных находятся в неожиданном состоянии, а запрос к API Orchestrator показал топологию репликации базы данных, которая включала только серверы из ЦОД западного побережья США.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Реакция**                    | К этому моменту группа реагирования решила вручную заблокировать внутренние инструменты развертывания, чтобы предотвратить внесение каких-либо дополнительных изменений. Так же группа реагирования перевела сайт в желтый статус. Это действие автоматически перевело ситуацию в активный инцидент и отправило предупреждение координатору инцидента, спустя 2 минуты координатор присоеденился к решению сложившейся ситуации. Так же Были вызваны дополнительные инженеры из команды разработки баз данных GitHub. Они начали исследовать текущее состояние, чтобы определить, какие действия необходимо предпринять, чтобы вручную настроить базу данных Восточного побережья США в качестве основной для каждого кластера и перестроить топологию репликации.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Восстановление**             | Команда работающая над инцидентом разработала следующий план:<br> 1) отключить репликацию и обработку webhook<br> 2) восстановиться из резервных копий<br> 3) синхронизировать реплики на обоих сайтах<br> 4) вернуться к стабильной топологии обслуживания<br> 5) возобновить обработку заданий в очереди<br> 6) ручное отслеживание и восстановление недостающих данных<br> Restoration plan:<br> ![norm](https://github.com/Rain-m-a-n/devops-netology/blob/master/%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B%20%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3%D0%B0/Home_Work_(10.6)/pics/plan.jpg)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Таймлайн**                   | **21 октября 2018, 22:52 UTC -** Нарушилась связь между двумя ЦОД US WEST и US EAST. Продолжительность 43 сек<br> **21 октября 2018, 22:52 UTC -** Был запущен процесс выбора нового лидера, в результате чего начал создавать топологию кластера БД на западе. После восстановления подключения приложения направили трафик по записи на новые основные сервера на западе. Таким образом на обоих серверах образовались данные, отсутствующие у другого и не получилось восстановить первичную топологию подключения<br> **21 октября 2018, 22:54 UTC -** Внутренние системы мониторинга начали генерировать оповещения о многочисленных сбоях в работе систем. В **23:02 UTC** Инженеры 1 линии поддержки определили, что топологии многочисленных кластеров баз данных находятся в неожиданном состоянии. А запрос к API Orchestrator показал топологию репликации базы данных, которая включала только серверы из ЦОД западного побережья США<br> **21 октября 2018, 23:07 UTC -** К этому моменту группа реагирования решила вручную заблокировать внутренние инструменты развертывания,чтобы предотвратить внесение каких-либо дополнительных изменений.В **23:09 UTC** группа реагирования перевела сайт в желтый статус, что инициировало оповещение координатора. В **23:11 UTC** присоединился координатор инцидентов и через две минуты изменил статус решения на красный<br> **21 октября 2018, 23:13 UTC -** К работе привлекли дополнительных разработчиков из инженерной группы БД, они начали исследовать текущее состояние, чтобы определить, какие действия необходимо предпринять, чтобы вручную настроить базу данных Восточного побережья США в качестве основной для каждого кластера и перестроить топологию репликации<br> **21 октября 2018, 23:19 UTC -** После запроса состояния кластеров базы данных стало ясно, что необходимо частично остановить выполнение заданий, записывающих метаданные о таких вещах, как push-уведомления. Стратегия заключалась в том, чтобы поставить целостность данных выше удобства использования сайта и времени восстановления<br> **22 октября 2018, 00:05 UTC -** Инженеры, участвующие в группе реагирования на инциденты, начали разработку плана по устранению несоответствий данных и реализации процедур аварийного восстановления репликкации данных в MySQL<br> **22 октября 2018, 00:41 UTC -** К этому времени был начат процесс резервного копирования для всех затронутых кластеров MySQL. Одновременно несколько групп инженеров искали способы ускорить передачу и восстановление данных, без их потерь<br> **22 октября 2018, 06:51 UTC -** Несколько кластеров завершили восстановление из резервных копий в центре обработки данных на Восточном побережье США и начали репликацию новых данных с Западного побережья<br> **22 октября 2018, 07:46 UTC -** GitHub опубликовал сообщение в блоге о инциденте и обещал уведомить о его решении<br> **22 октября 2018, 11:12 UTC -** Все первичные базы данных снова установлены на восточном побережье США. В результате сайт стал гораздо более отзывчивым, поскольку записи теперь направлялись на сервер базы данных, который находился в том же физическом центре обработки данных, что и наш уровень приложений. Несмотря на существенное повышение производительности, десятки реплик чтения базы данных по-прежнему отставали от основной на несколько часов<br> **22 октября 2018, 13:15 UTC -** К этому моменту было ясно, что задержки репликации увеличивались, а не уменьшались в направлении к согласованному состоянию. Ранее во время инцидента мы начали предоставлять дополнительные реплики чтения MySQL в общедоступном облаке Восточного побережья США. Как только они стали доступны, стало проще распределить объем запросов на чтение между большим количеством серверов. Снижение совокупного использования всех реплик чтения позволило репликации наверстать упущенное<br> **22 октября 2018, 16:24 UTC -** Как только реплики были синхронизированы, выполнили переход на исходную топологию, решая непосредственные проблемы с задержкой и доступностью. В рамках осознанного решения отдать приоритет целостности данных, был сохранен статус службы красным, пока не обрабатаются накопившиеся данные<br> **22 октяюря 2018, 16:45 UTC -** Пришлось сбалансировать возросшую нагрузку, связанную с отставанием, было зарегистрировано более пяти миллионов событий-перехватчиков и 80 тысяч сборок страниц в очереди. На момент включения обработки этих данных, было обработано 200 000 webhook, которые пережили внутренний срок жизни и были удалены. Обнаружив это, была приостановлена обработка и внесены изменения, чтобы на время увеличить TTL до тех пор, пока не завершится обработка всего накопившегося массива данных и не будет подтверждения, что сервис вернулся к нормальному уровню производительности<br> **22 октября 2018, 23:03 UTC -** Все ожидающие сборки webhook и страниц были обработаны, а целостность и правильная работа всех систем подтверждены. Статус сайта изменился на зеленый |
| **Последующие действия**       | **1)** Оптимизация конфигурации Orchestratorа, чтобы предотвратить распространение основных баз данных за пределы региональных границ<br> **2)** Переработать оповещения о статусе системы. Сделать её более информативной. Настроить оповещение о статусе отдельных компонентах сервиса<br> **3)** Закончить работу, которая началась за несколько недель до инцидента. Работа по улучшению отказоустойчивости сервиса, чтобы система оставалась доступной даже при отказе целого датацентра                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               